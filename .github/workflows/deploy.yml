name: Self-hosted deploy to docker
on:
  push:
    branches: [test-deploy]

jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Build the docker image
        run: docker build -t matebot-image:$(echo ${GITHUB_SHA} | cut -c1-8) .
      - name: Stop the current container
        if: always()
        run: docker stop matebot-test
      - name: Remove the current container
        if: always()
        run: docker rm matebot-test
      - name: Run the new container
        if: always()
        run: >
          docker run -d --restart always
          -e DISCORD_PREFIX=${{ secrets.DISCORD_PREFIX }}
          -e DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}
          --name matebot-test matebot-image:$(echo ${GITHUB_SHA} | cut -c1-8)
