name: Self-hosted deploy to docker
on:
  push:
    branches: [test-deploy]

jobs:
  build:
    runs-on: self-hosted
    env:
      TAG: ${GITHUB_SHA::8}
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Build the docker image
        run: docker build --tag matebot-image:$TAG .
      - name: Stop the current container
        run: docker stop matebot-test
      - name: Remove the current container
        run: docker rm matebot-test
      - name: Run the new container
        run: |
          docker run -d \
          --restart always \
          --name matebot-test \
          -e DISCORD_PREFIX=${{ secrets.DISCORD_PREFIX }} \
          -e DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }} \
          -e FAUNADB_SECRET_KEY=${{ secrets.FAUNADB_SECRET_KEY }} \
          -e EVENTS_CHANNEL_ID=${{ secrets.EVENTS_CHANNEL_ID }} \
          -e TWITTER_API_KEY=${{ secrets.TWITTER_API_KEYL }}
          -e TWITTER_API_SECRET=${{ secrets.TWITTER_API_SECRET }}
          -e TWITTER_ACCESS_KEY=${{ secrets.TWITTER_ACCESS_KEY  }}
          -e TWITTER_ACCESS_SECRET=${{ secrets.TWITTER_ACCESS_SECRET }}
          -e TWITTER_USER_ID=${{ secrets.TWITTER_USER_ID }}
          -e TWITTER_USER_URL=${{ secrets.TWITTER_USER_URL }}
          -e TWITTER_FILTER=${{ secrets.TWITTER_FILTER }}
          matebot-image:$TAG
